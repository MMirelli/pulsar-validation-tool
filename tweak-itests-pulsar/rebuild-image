set -e

HERE=$(pwd)
cd $PULSAR_DIR
# Edit here for adding other submodules
BUILD_MODULES=${BUILD_MODULES:-"pulsar-common,pulsar-broker-common,pulsar-broker,pulsar-metadata"}

PULSAR_VERSION=$(mvnd help:evaluate -Dexpression=project.version -q -DforceStdout -f pom.xml )
mvnd clean install -DskipTests -Dcheckstyle.skip -Dspotbugs.skip -pl $BUILD_MODULES
rm -rf tests/docker-images/latest-version-image/libs
mkdir tests/docker-images/latest-version-image/libs

MODULES_ARR=(${BUILD_MODULES//,/ })
echo $MODULES_ARR


for module in "${MODULES_ARR[@]}"
do
   echo "Copying module $module"
   cp ${module}/target/${module}.jar tests/docker-images/latest-version-image/libs/org.apache.pulsar-${module}-${PULSAR_VERSION}.jar
done

# Build dockerfile
cd tests/docker-images/latest-version-image
docker build -t apachepulsar/pulsar-test-latest-version:latest-tweak -f ${HERE}/fast-rebuild-Dockerfile libs

echo "********************************************"
echo "Docker image created: apachepulsar/pulsar-test-latest-version:latest-tweak"
echo "********************************************"



